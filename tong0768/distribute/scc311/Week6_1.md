### Paxos 协议中文教案

---

#### **课程信息**
- **课程名称**：SCC.311 分布式系统
- **主题**：Paxos 共识协议
- **课时**：1-2 课时
- **教学目标**：
    1. 理解状态机复制（SMR）的基本原理及其在容错系统中的作用。
    2. 掌握原子多播（Atomic Multicast）的局限性及引入共识协议的必要性。
    3. 掌握 Paxos 协议的核心设计、角色分工及两阶段流程。
    4. 分析 Paxos 在不同故障场景下的行为，理解其安全性与活性。

---

#### **教学内容与步骤**

---

##### **1. 状态机复制（State Machine Replication, SMR）**
- **核心思想**：
    - 所有副本初始状态一致，按相同顺序处理客户端请求，确保最终状态一致。
    - **示例**：拍卖系统中，副本需按相同顺序执行 `注册用户` 和 `创建拍卖` 操作，否则状态可能不一致。
- **问题场景**：
    - 若副本处理顺序不同（如先执行 `newAuction` 后 `register`），导致操作失败或状态分歧。
    - **图示说明**（参考文档第4页）：不同顺序导致副本状态不一致。

---

##### **2. 原子多播（Atomic Multicast）的局限性**
- **初步解决方案**：
    - 领导者（Leader）通过两阶段提交（2PC）向所有副本广播操作请求。
    - **成功条件**：所有副本返回 `Commit`，否则中止操作（`ABORT`）。
- **局限性**：
    - 领导者或网络故障时，系统完全停滞（无法处理新操作）。
    - **示例**（文档第15页）：领导者故障导致副本进入维护状态。

---

##### **3. 共识协议的必要性**
- **核心目标**：
    - 在部分同步网络、允许节点崩溃恢复的模型中，确保副本对操作序列达成一致。
    - **关键挑战**：区分节点故障与网络延迟（失败与高延迟无法区分）。

---

##### **4. Paxos 协议详解**

###### **4.1 系统模型假设**
- **网络与时序**：
    - 部分同步网络：消息可能丢失、乱序或延迟，但最终可达。
    - 节点可能崩溃并恢复，但无拜占庭故障（消息不篡改）。
- **角色划分**：
    1. **提议者（Proposer）**：发起提案（操作）。
    2. **接受者（Acceptor）**：参与提案的投票与存储。
    3. **学习者（Learner）**：学习已达成共识的操作。

###### **4.2 两阶段流程**
- **阶段1：Prepare & Promise**
    1. **提议者**生成全局唯一提案号 `n`（逻辑时间戳，如 `1.1`）。
    2. 向所有接受者发送 `Prepare(n)` 消息。
    3. **接受者**响应：
        - 若 `n` 大于已承诺的提案号，返回 `Promise(n)`，并附带已接受的最高提案值（若有）。
        - 否则忽略。
- **阶段2：Accept & Learn**
    1. **提议者**收到多数派（半数+1）的 `Promise` 后：
        - 若存在已接受的提案值，选择最高提案值作为本次提案值 `v`。
        - 否则自行选择提案值 `v`。
    2. 发送 `Accept(n, v)` 给接受者。
    3. **接受者**若未承诺更高 `n`，则接受 `(n, v)` 并持久化，广播 `Learn(n, v)` 给学习者。
    4. **学习者**收到多数派的 `Learn` 后执行操作。

###### **4.3 关键机制**
- **提案号唯一性**：通过 `n + 节点ID` 确保全局唯一（如 `1.1`、`2.3`）。
- **多数派原则**：确保协议在部分节点故障时仍能推进。
- **持久化存储**：接受者需将承诺和接受的提案写入磁盘，防止崩溃后状态丢失。

##### **5. 故障场景分析**
- **场景1：提议者在 Prepare 阶段后崩溃**
    - 新提议者以更高提案号重启流程，覆盖旧提案。
- **场景2：提议者在 Accept 阶段后崩溃**
    - 已接受的提案值会被新提议者在 Prepare 阶段发现并继续推进。
- **场景3：接受者在 Accept 后崩溃**
    - 其他接受者的多数派仍可完成 Learn 阶段。
- **场景4：多个提议者并发提案**
    - 高提案号优先，最终由多数派接受一个值（如 `2.3` > `1.1`）。

##### **6. Multi-Paxos 与全序多播**
- **Multi-Paxos**：
    - 通过一次 Prepare 阶段选举稳定领导者，后续操作直接进入 Accept 阶段，提升效率。
    - **应用场景**：构建复制日志（如分布式数据库的日志同步）。
- **共识与全序多播的等价性**：
    - 每轮 Paxos 决定一个操作顺序，多次共识实现全序多播。

##### **7. Paxos 属性**
- **安全性（Safety）**：
    - 每个轮次仅一个值被接受，学习者仅执行已达成共识的值。
- **活性（Liveness）**：
    - 在多数派存活时，协议最终推进。需 `2f+1` 节点容忍 `f` 个故障。
